$(document).ready(function(){function a(){d3.select("#bad-coords-div").classed("collapse in")||($("#bad-coords-div").collapse("show"),d3.select("#bad-coords-div").transition().duration(200).style("opacity",1))}function b(){d3.select("#bad-coords-div").classed("collapse in")&&($("#bad-coords-div").collapse("hide"),d3.select("#bad-coords-div").transition().duration(200).style("opacity",0))}function c(a,b){return d3.range(b.length).map(function(c){return d3.zip(a,b[c])})}function d(a,b,c,d,f,g,i,j){var k=d3.select("#line-plot-div");k.classed("collapse in")?e(b,c,d,f,g,i,j):a&&($(k[0][0]).on("shown.bs.collapse",function(){e(b,c,d,f,g,i,j),$("#postage-stamp-div").on("shown.bs.collapse",function(){h(),$("#download-div").collapse("show")}),$("#postage-stamp-div").collapse("show")}),$(k[0][0]).collapse("show"))}function e(a,b,d,e,f,g,h){function R(){d3.select("#focus").attr("display",null);var a=d3.mouse(this)[0],b=x.invert(a),c=P(mu,b,1);x0=mu[c-1],x1=mu[c];for(var e=best[c-1],f=best[c],g=(b-x0)/(x1-x0),h=e+(f-e)*g,j=(y(h),[]),k=0;k<samples.length;k++)e=samples[k][c-1],f=samples[k][c],j.push(e+(f-e)*g);j.sort(d3.ascending);var l=d3.quantile(j,.1587),m=d3.quantile(j,.8413),n=d3.median(j),o=y(l),p=y(m),q=y(n),r=x(d[0]);DM=Math.pow(10,b/5-2),d3.select("#x-indicator").attr("y1",y(0)).attr("y2",q).attr("x1",a).attr("x2",a),d3.select("#y-indicator").attr("y1",q).attr("y2",q).attr("x1",r).attr("x2",a),d3.select("#y-spread-indicator").attr("x",r).attr("y",p).attr("width",d3.max([0,a-r])).attr("height",o-p),d3.select("#dist-label").text("d = "+Q(DM)+" kpc"),d3.select("#EBV-label").text("E(B-V) = "+Q(n)),d3.select("#EBV-plus").text("+"+Q(m-n)),d3.select("#EBV-minus").text("-"+Q(n-l))}if(d3.select("#line-plot-div").classed("collapse in")){var i=$(a).width(),j=$(a).height(),k=i/600;scaling=d3.max([.5,i/600]),scaling=d3.min([2,scaling]),console.log("scaling: "+scaling),labelsize=14*scaling,ticksize=12*scaling;var l={left:70*scaling,right:20*scaling,bottom:80*scaling,top:20*scaling},m=i-l.left-l.right,n=j-l.bottom-l.top;x=d3.scale.linear().domain(d3.extent(d)).range([0,m]),yMax=d3.max(f,function(a){return d3.max(a)}),y=d3.scale.linear().domain([0,1.1*yMax]).range([n,0]);var o=d3.svg.line().x(function(a){return x(a[0])}).y(function(a){return y(a[1])}),p=d3.svg.axis().scale(x).orient("bottom"),q=d3.svg.axis().scale(y).orient("left").ticks(6);d3.select(a).selectAll("svg")[0].length<1&&(svg=d3.select(a).append("svg").append("g").attr("id","main-group"),lineGroup=svg.append("g").attr("id","DM-EBV-lines"),svg.append("g").attr("class","toggle-converged").style("opacity",0).append("text").attr("id","convergence-warning").style("text-anchor","end").style("font-family","Cutive Mono").style("fill","red").text("non-converged!"),svg.append("g").attr("class","nodata-on").style("opacity",0).append("text").attr("id","nodata-indicator").style("text-anchor","middle").style("font-family","Cutive Mono").style("fill","steelblue").style("opacity",.5).text("No Data")),d3.select(a).select("svg").attr("width",i).attr("height",j).attr("viewBox","0 0 "+i+" "+j),d3.select("#main-group").attr("transform","translate("+l.left+","+l.top+")"),d3.select("#convergence-warning").transition().duration(b).attr("x",x(d[d.length-1])).attr("y",n).attr("dy",-1*ticksize+"pt").style("font-size",ticksize+"pt"),d3.select("#nodata-indicator").transition().duration(b).attr("x",.5*m).attr("y",.5*n).attr("dy",-.5*ticksize+"pt").style("font-size",3*ticksize+"pt"),svg.selectAll(".x.axis")[0].length<1?svg.append("g").attr("class","x axis").attr("transform","translate(0,"+n+")").call(p).append("text").attr("id","xlabel").attr("x",m/2).attr("dy",3*ticksize+"pt").text("Distance Modulus (mags)").style("text-anchor","middle"):(svg.selectAll(".x.axis").attr("transform","translate(0,"+n+")").transition(b).duration(b).call(p),d3.select("#xlabel").attr("x",m/2).attr("dy",3*ticksize+"pt")),svg.selectAll(".y.axis")[0].length<1?svg.append("g").attr("class","y axis").call(q).append("text").attr("id","ylabel").attr("transform","rotate(-90)").attr("y",0).attr("x",-n/2).attr("dy",-3*ticksize+"pt").style("text-anchor","middle").text("E(B-V) (mags)"):(svg.selectAll(".y.axis").transition().duration(b).call(q),d3.select("#ylabel").attr("x",-n/2).attr("dy",-3*ticksize+"pt")),d3.selectAll(".tick > text").style("font-size",ticksize+"pt").style("font-family","Lora"),d3.selectAll(".axis > text").style("font-size",labelsize+"pt").style("font-family","Lora"),0==g?(lineColor="red",d3.selectAll(".toggle-converged").transition().duration(b).style("opacity",1)):(lineColor="steelblue",d3.selectAll(".toggle-converged").transition().duration(b).style("opacity",0)),1==h?(d3.selectAll(".nodata-on").transition().duration(b).style("opacity",1),d3.selectAll(".nodata-off").transition().duration(b).style("opacity",0)):(d3.selectAll(".nodata-on").transition().duration(b).style("opacity",0),d3.selectAll(".nodata-off").transition().duration(b).style("opacity",1)),bestData=[d3.zip(d,e)];var r=lineGroup.selectAll("#best").data(bestData).attr("class","line");r.transition().duration(b).attr("stroke",lineColor).attr("d",o),r.enter().append("path").attr("id","best").attr("class","line").attr("d",o).attr("stroke",lineColor).attr("stroke-width","2.5px"),r.exit().remove(),sampleData=c(d,f);var r=lineGroup.selectAll("#samples").data(sampleData).attr("class","line");r.transition().duration(b).attr("stroke",lineColor).attr("d",o),r.enter().append("path").attr("id","samples").attr("class","line").attr("d",o).attr("opacity",.2).attr("stroke",lineColor).attr("stroke-width","1.5px"),r.exit().remove();var s=15.5,t=d3.range(0,1.251,.25).map(function(a){return s+a}),u=[.7,.75,.75,.85,1,1],v=[[.1,.1,.15,.2,.25,.25],[.2,.25,.25,.3,.35,.35],[0,.05,.3,.35,.4,.4]],w=.25*yMax,z=.45*yMax,A=t.length-1,B=d3.scale.linear().domain([0,1]).range([w,z]);if(d3.select("#main-group").selectAll("#legend-wrapper")[0].length<1){var C=d3.select("#main-group").append("g").attr("id","legend-wrapper").attr("class","nodata-off"),D=C.append("g").attr("id","legend");C.append("rect").attr("id","legend-frame").style("fill","black").style("fill-opacity",.01).style("stroke","black").style("stroke-width","1pt").style("stroke-opacity",.05),D.append("text").attr("id","legend-best-label").style("text-anchor","start").style("font-family","Cutive Mono").style("fill","steelblue").style("opacity",1).text("best fit"),D.append("text").attr("id","legend-sample-label").style("text-anchor","start").style("font-family","Cutive Mono").style("fill","steelblue").style("opacity",1).text("samples")}var E={x:5,y:5},F=y(w)-y(z),G=1.7*(scaling/k);G=(1+G)*(x(t[A])-x(t[0])),G+=2*E.y;var H=x(d[d.length-1])-(x(t[0])+G),I={x:x(t[0])+H,y:y(z)-.1*F,width:G,height:1.1*F+2*E.y};d3.select("#legend-frame").transition().duration(b).attr("x",I.x-E.x+"px").attr("y",I.y-E.y+"px").attr("width",I.width+"px").attr("height",I.height+"px"),d3.select("#legend-best-label").transition().duration(b).attr("x",x(t[A]+.25)+H).attr("y",y(B(u[A]))).attr("dy",.2*ticksize+"pt").style("font-size",.8*ticksize+"pt").style("fill",lineColor),d3.select("#legend-sample-label").transition().duration(b).attr("x",x(t[A]+.25)+H).attr("y",y(B(.325))).attr("dy",.2*ticksize+"pt").style("font-size",.8*ticksize+"pt").style("fill",lineColor),t=t.map(function(a){return a+x.invert(H)-x.invert(0)});var J=[d3.zip(t,u.map(B))],K=d3.select("#legend").selectAll("#legend-line-best").data(J).attr("class","line");K.transition().duration(b).attr("stroke",lineColor).attr("d",o).attr("stroke-width","2.5px"),K.enter().append("path").attr("id","legend-line-best").attr("class","line").attr("d",o).attr("stroke",lineColor).attr("stroke-width","2.5px"),K.exit().remove();var L=v.map(function(a){return a.map(B)}),M=c(t,L),N=d3.select("#legend").selectAll("#legend-line-samples").data(M).attr("class","line");N.transition().duration(b).attr("stroke",lineColor).attr("d",o).attr("stroke-width","1.5px"),N.enter().append("path").attr("id","legend-line-samples").attr("class","line").attr("d",o).attr("opacity",.2).attr("stroke",lineColor).attr("stroke-width","1.5px"),N.exit().remove();var O=.7;svg.selectAll("#focus")[0].length<1?(focus=svg.append("g").attr("id","focus").attr("display","none"),svg.append("rect").attr("id","mouse-overlay").attr("class","overlay").attr("width",m).attr("height",n).on("mouseover",function(){d3.select("#focus").attr("display",null)}).on("mouseout",function(){d3.select("#focus").attr("display","none")}).on("mousemove",R),focus.append("line").attr("id","x-indicator").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",n).attr("stroke","black").attr("stroke-width","2px").attr("opacity",.15),focus.append("line").attr("id","y-indicator").attr("x1",0).attr("x2",m).attr("y1",0).attr("y2",0).attr("stroke","black").attr("stroke-width","2px").attr("opacity",.15),focus.append("rect").attr("id","y-spread-indicator").attr("fill","black").attr("fill-opacity",.05),txtEl=focus.append("text").attr("id","text-indicator").attr("x",0).attr("y",0).style("text-anchor","start").style("font-size",ticksize+"pt").style("font-family","Cutive Mono").style("fill","steelblue").style("opacity",.75),txtEl.append("tspan").attr("id","dist-label").attr("x",.8*ticksize+"pt"),txtEl.append("tspan").attr("id","EBV-label").attr("x",.8*ticksize+"pt").attr("dy",ticksize+"pt"),txtEl.append("tspan").attr("id","EBV-plus").attr("dx",.25*ticksize+"pt").attr("dy",-O*ticksize+"pt"),txtEl.append("tspan").attr("id","EBV-minus").attr("dy",O*ticksize+"pt")):(d3.select("#mouse-overlay").attr("width",m).attr("height",n),d3.select("#focus").attr("display","none"),d3.select("#dist-label").attr("x",.8*ticksize+"pt"),d3.select("#EBV-label").attr("x",.8*ticksize+"pt").attr("dy",ticksize+"pt")),d3.select("#EBV-plus").attr("dx",.25*ticksize+"pt").attr("dy",-.65*O*ticksize+"pt").style("font-size",O*ticksize+"pt"),d3.select("#EBV-minus").attr("dx",-3*O*ticksize+"pt").attr("dy",O*ticksize+"pt").style("font-size",O*ticksize+"pt"),d3.select("#text-indicator").transition().duration(b).attr("x",.025*m).attr("y",.015*n).style("font-size",ticksize+"pt").attr("dy",.5*ticksize+"pt");var P=d3.bisector(function(a){return a}).left,Q=d3.format(".2f")}}function f(c,e){var f=$.now();if(queryLock&&f-submitTimeLast<queryTimeout)return console.log("Query already in progress."),!1;submitTimeLast=f,queryLock=!1,$("#enter-coords-alert").alert("close");var i=!1;if("undefined"===typeof c||"undefined"===typeof e){if(c=$('input[name="gal-l"]').val(),e=$('input[name="gal-b"]').val(),!$.isNumeric(c)||!$.isNumeric(e))return void a();if(e<-90||e>90)return void a();b()}else i=!0,b();var j=c,k=e;if(!useGalactic){var l=equ2gal_J2000(j,k);j=l.l,k=l.b,console.log("(l,b) = ("+l.l+", "+l.b+")")}return data={l:j,b:k},$("#submit-btn-icon").attr("class","fa fa-spinner fa-spin fa-lg"),queryLock=!0,$.ajax({type:"POST",url:"/gal-lb-query",contentType:"application/json; charset=utf-8",data:JSON.stringify(data),success:function(a){if(queryLock=!1,querySuccess=$.parseJSON(a.success),mu=$.parseJSON(a.mu),best=$.parseJSON(a.best),samples=$.parseJSON(a.samples),converged=$.parseJSON(a.converged),tableData=$.parseJSON(a.table_data),lCur=$.parseJSON(a.l),bCur=$.parseJSON(a.b),rCur=$.parseJSON(a.radius),noData=1-querySuccess,d(!0,linePlotContainer,500,mu,best,samples,converged,noData),$("#postage-stamp-1").attr("src",a.image1),$("#postage-stamp-2").attr("src",a.image2),$("#postage-stamp-3").attr("src",a.image3),$("#ps-label-1").text(a.label1),$("#ps-label-2").text(a.label2),$("#ps-label-3").text(a.label3),$("#submit-btn-icon").attr("class","glyphicon glyphicon-search"),1==querySuccess?(g(!1),$("#table-btn").attr("href",tableData)):g(!0),h(),i){var b=d3.format(".3f");$('input[name="gal-l"]').val(b(c)),$('input[name="gal-b"]').val(b(e))}},error:function(){queryLock=!1,$("#submit-btn-icon").attr("class","glyphicon glyphicon-ok"),g(!0)}}),!0}function g(a){d3.select("#table-btn").classed("disabled",a)}function h(){if(d3.select("#postage-stamp-div").classed("collapse in")){var a=d3.selectAll(".ps-container"),b=d3.selectAll(".ps-overlay");if(b[0].length<1){b=a.append("svg").attr("class","ps-overlay").style("position","absolute").style("top","0px").style("left","0px");var c=b.append("g").attr("class","ps-bullseye").style("opacity",.75);c.append("circle").attr("class","ps-bullseye-outer").attr("fill","none").attr("stroke","#FFD35C").attr("stroke-width","3px").attr("x",0).attr("y",0),c.append("circle").attr("class","ps-bullseye-inner").attr("fill","#FFD35C").attr("x",0).attr("y",0),focus=b.append("g").attr("class","ps-focus").style("opacity",0),focus.append("rect").attr("class","ps-text-bg");var d=focus.append("text").attr("class","ps-text-indicator").style("text-anchor","start");d.append("tspan").text("l = 0").attr("class","ps-l-label"),d.append("tspan").attr("class","ps-b-label").text("b = 0"),psOverlayRect=b.append("rect").attr("class","overlay"),psOverlayRect.each(function(a,b){var c=d3.selectAll(".ps-focus")[0][b];d3.select(this).on("mouseover",function(){d3.select(c).style("opacity",1)}).on("mouseout",function(){d3.select(c).style("opacity",0)})})}a.each(function(){var c=i(d3.select(this).select(".ps-img")[0]);d3.select(this).select(".ps-overlay").attr("width",c.width+"px").attr("height",c.height+"px").style("left",c.left+"px").style("top",c.top+"px");var d=c.width/40;d=d3.max([d,8]),d=d3.min([d,24]);var e=d/4;d3.select(this).select(".ps-bullseye-outer").attr("r",d),d3.select(this).select(".ps-bullseye-inner").attr("r",e),d3.select(this).select(".ps-bullseye").attr("transform","translate("+c.width/2+","+c.height/2+")");var g=c.width/200;g=d3.max([g,.5]),g=d3.min([g,3]);var h=11*g,l=d3.select(this).select(".ps-text-indicator").attr("x",1.2*h+"pt").attr("y",1.2*h+"pt").style("font-size",h+"pt");lLabPS=l.select(".ps-l-label"),lTxtTmp=lLabPS.text(),lLabPS.attr("x",.5*h+"pt").text("l = 359.9\xb0"),l.select(".ps-b-label").attr("x",.5*h+"pt").attr("dy",h+"pt");var m=l[0][0].getBBox();lLabPS.text(lTxtTmp),xMargin=.5*m.x,yMargin=.5*m.y,d3.select(this).select(".ps-text-bg").attr("x",m.x-xMargin+"px").attr("y",m.y-yMargin+"px").attr("width",m.width+2*xMargin+"px").attr("height",m.height+2*yMargin+"px").attr("rx",.75*xMargin+"px").attr("ry",.75*xMargin+"px");var n=this,o=deg2rad(lCur),p=Math.cos(deg2rad(bCur)),q=Math.sin(deg2rad(bCur)),r=j(deg2rad(rCur),0,0,1,0).x,s=d3.format(".1f"),t=function(a){var b=d3.mouse(a)[0],d=d3.mouse(a)[1],e=-2*(b/c.width-.5)*r,f=-2*(d/c.height-.5)*r,g=k(e,f,o,p,q);return{l:rad2deg(g.lng),b:rad2deg(g.lat)}};d3.select(this).select(".overlay").attr("width",c.width).attr("height",c.height).on("mousemove",function(){var a=t(this),b="",c="";if(useGalactic)b="l = "+s(a.l)+"\xb0",c="b = "+s(a.b)+"\xb0";else{var d=gal2equ_J2000(a.l,a.b);b="\u03b1 = "+s(d.a)+"\xb0",c="\u03b4 = "+s(d.d)+"\xb0"}d3.select(n).select(".ps-l-label").text(b),d3.select(n).select(".ps-b-label").text(c)}).on("click",function(){var a=t(this);if(useGalactic)f(a.l,a.b);else{var b=gal2equ_J2000(a.l,a.b);f(b.a,b.d)}})})}}function i(a){var b=$(a).position(),c=b.left,d=b.top;c+=parseInt($(a).css("padding-left"),10),d+=parseInt($(a).css("padding-top"),10),c+=parseInt($(a).css("margin-left"),10),d+=parseInt($(a).css("margin-top"),10);var e=parseInt($(a).css("width"),10),f=parseInt($(a).css("height"),10);return{left:c,top:d,width:e,height:f}}function j(a,b,c,d,e){var f=Math.cos(b),g=Math.sin(b),h=Math.cos(a-c),i=Math.sin(a-c),j=1/(e*g+d*f*h),k=j*f*i,l=j*(d*g-e*f*h);return{x:k,y:l}}function k(a,b,c,d,e){var f=Math.sqrt(a*a+b*b),g=Math.atan(f),h=Math.cos(g),i=Math.sin(g),j=Math.asin(h*e+b*i*d/f),k=c+Math.atan2(a*i,f*d*h-b*e*i);return k>2*Math.PI?k-=2*Math.PI:k<0&&(k+=2*Math.PI),{lng:k,lat:j}}function m(a,b,c){var d=$(a).width(),e=$(a).height();setInterval(function(){var c=$(a).width(),f=$(a).height();(c!=d||f!=e)&&(d=c,e=f,console.log("resized"),b())},c)}useGalactic=!0,$("#coord-toggle").change(function(){$(this).prop("checked")?(useGalactic=!0,d3.select("#gal-l-input").attr("placeholder","lon. (\xb0)"),d3.select("#gal-b-input").attr("placeholder","lat. (\xb0)"),d3.select("#gal-l-symbol").text("\u2113"),d3.select("#gal-b-symbol").text("b"),d3.select("#submit-btn").classed("btn-success",!0),d3.select("#submit-btn").classed("btn-primary",!1)):(useGalactic=!1,d3.select("#gal-l-input").attr("placeholder","R.A. (\xb0)"),d3.select("#gal-b-input").attr("placeholder","Dec. (\xb0)"),d3.select("#gal-l-symbol").text("\u03b1"),d3.select("#gal-b-symbol").text("\u03b4"),d3.select("#submit-btn").classed("btn-success",!1),d3.select("#submit-btn").classed("btn-primary",!0))}),linePlotContainer=".line-plot-container",mu=d3.range(4,19.01,.5),best=Array.apply(null,new Array(mu.length)).map(Number.prototype.valueOf,0),samples=[best],converged=1,tableData="",noData=0,lCur=0,bCur=0,rCur=0,submitTimeLast=0,queryTimeout=5e3,queryLock=!1,$("#submit-btn").click(function(){f()}),$("#gal-l-input").keypress(function(a){var b=a.which;13==b&&f()}),$("#gal-b-input").keypress(function(a){var b=a.which;13==b&&f()});{var l=function(a,b){var c=-1;return function(){c>-1&&window.clearTimeout(c),c=window.setTimeout(a,b)}},n=l(function(){d(!1,linePlotContainer,200,mu,best,samples,converged,noData)},125);l(function(){h()},250)}$(window).resize(n),m(d3.select(".ps-container")[0][0],h,500)});
