{% extends "layout.html" %}
{% set active_page = "query" %}

{% block content %}

<div class="container-fluid">
  <div class="row black">
    
    <div class="col-xs-12 col-sm-6 col-md-6 padding-xs-5 green">
      <div class="input-group">
        <span class="input-group-addon"><i>&#x2113</i></span>
        <input id="gal-l-input" name="gal-l" type="text" class="form-control" placeholder="lon. (&deg)">
      </div>
    </div>
    
    <div class="col-xs-12 col-sm-6 col-md-6 padding-xs-5 blue">
      <div class="input-group">
        <span class="input-group-addon"><i>b</i></span>
        <input id="gal-b-input" name="gal-b" type="text" class="form-control" placeholder="lat. (&deg)">
        <span class="input-group-btn">
          <button class="btn btn-success" type="submit" id="submit-btn">
            <span class="glyphicon glyphicon-ok" id="submit-btn-icon"></span>
          </button>
      </span>
      </div>
    </div>
    
    <div class="col-xs-12 col-sm-12 brown">
      <h1>Reddening vs. Distance</h1>
      <div class="box-aspect-2-1">
        <div class="line-plot-container"></div>
      </div>
    </div>
    
    <div class="col-xs-12 col-sm-12 cyan">
      <h1>Postage Stamps</h1>
      
      <div class="row">
        <div class="thumbnail col-xs-12 col-sm-4 red">
          <div class="ps-container">
            <img id="postage-stamp-1" src="" class="img-responsive" />
            <span class="fa fa-dot-circle-o"></span>
          </div>
          <h4 id="ps-label-1" class="ps-label"></h4>
        </div>
        <div class="thumbnail col-xs-12 col-sm-4 red">
          <div class="ps-container">
            <img id="postage-stamp-2" src="" class="img-responsive" />
            <span class="fa fa-dot-circle-o"></span>
          </div>
          <h4 id="ps-label-2" class="ps-label"></h4>
        </div>
        <div class="thumbnail col-xs-12 col-sm-4 red">
          <div class="ps-container">
            <img id="postage-stamp-3" src="" class="img-responsive" />
            <span class="fa fa-dot-circle-o"></span>
          </div>
          <h4 id="ps-label-3" class="ps-label"></h4>
        </div>
      </div>
    </div>
  
  </div>
</div>

<script type=text/javascript>
  $(document).ready(function() {
    
    function packData(xVals, yData) {
      return d3.range(yData.length).map( function(idx) {
        return d3.zip(xVals, yData[idx]);
      });
    };
    
    function drawPlot(container, dt, xVals, yBest, ySamples) {
      var fullwidth = $(container).width(),
          fullheight = $(container).height();
      
      scaling = d3.max([0.5, fullwidth/600]);
      scaling = d3.min([2, scaling]);
      
      console.log("scaling: " + scaling);
      
      labelsize = 14 * scaling;
      ticksize = 12 * scaling;
      
      var margins = {left:70*scaling, right:20*scaling,
                     bottom:80*scaling, top:20*scaling};
      
      var width = fullwidth - margins.left - margins.right,
          height = fullheight - margins.bottom - margins.top;
      
      var x = d3.scale.linear()
        .domain(d3.extent(mu))
        .range([0, width]);
      
      var y = d3.scale.linear()
        .domain([0, 1.1*d3.max(best)])
        .range([height, 0]);
      
      var line = d3.svg.line()
        .x(function(d) { return x(d[0]); })
        .y(function(d) { return y(d[1]); });
      
      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
      
      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(6);
      
      // SVG Canvas
      if (d3.select(container).selectAll("svg")[0].length < 1) {
        svg = d3.select(container).append("svg")
          .attr("width", fullwidth)
          .attr("height", fullheight)
          .attr("viewBox", "0 0 " + fullwidth + " " + fullheight)
          .append("g")
            .attr("transform", "translate(" + margins.left + "," + margins.top + ")");
      } else {
        d3.select(container).select("svg")
          .attr("width", fullwidth)
          .attr("height", fullheight)
          .attr("viewBox", "0 0 " + fullwidth + " " + fullheight)
          .select("g")
            .attr("transform", "translate(" + margins.left + "," + margins.top + ")");
      }
      
      // x-Axis
      if (svg.selectAll(".x.axis")[0].length < 1) {
        svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("id", "xlabel")
          .attr("x", width/2)
          .attr("dy", (3*ticksize) + "pt")
          .text("Distance Modulus (mags)")
          .style("text-anchor", "middle");
      } else {
        svg.selectAll(".x.axis")
          .attr("transform", "translate(0," + height + ")")
          .transition(dt).duration(dt)
          .call(xAxis)
        .select("#xlabel")
          .attr("x", width/2)
          .attr("dy", (3*ticksize) + "pt");
      }
      
      // y-Axis
      if (svg.selectAll(".y.axis")[0].length < 1) {
        svg.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text")
          .attr("id", "ylabel")
          .attr("transform", "rotate(-90)")
          .attr("y", 0)
          .attr("x", -height/2)
          .attr("dy", (-3*ticksize) + "pt")
          .style("text-anchor", "middle")
          .text("E(B-V) (mags)");
      } else {
        svg.selectAll(".y.axis")
          .transition().duration(dt)
          .call(yAxis)
        .select("#ylabel")
          .attr("x", -height/2)
          .attr("dy", (-3*ticksize) + "pt");
      }
      
      // Fonts
      d3.selectAll(".tick > text")
        .style("font-size", ticksize + "pt")
        .style("font-family", "Lora");
      
      d3.selectAll(".axis > text")
        .style("font-size", labelsize + "pt")
        .style("font-family", "Lora");
      
      // Best Line
      data = [d3.zip(xVals, yBest)];
      
      var lines = svg.selectAll("#best").data(data).attr("class", "line");
      
      // transition from previous paths to new paths
      lines.transition().duration(dt)
        .attr("d", line);
      
      // enter any new data
      lines.enter()
        .append("path")
        .attr("id", "best")
        .attr("class", "line")
        .attr("d", line)
        .attr("stroke", "steelblue")
        .attr("stroke-width", "2.5px");
      
      // exit
      lines.exit()
        .remove();
      
      // Samples
      data = packData(xVals, ySamples);
      
      var lines = svg.selectAll("#samples").data(data).attr("class", "line");
      
      // transition from previous paths to new paths
      lines.transition().duration(dt)
        .attr("d", line);
      
      // enter any new data
      lines.enter()
        .append("path")
        .attr("id", "samples")
        .attr("class", "line")
        .attr("d", line)
        .attr("opacity", 0.2)
        .attr("stroke", "steelblue")
        .attr("stroke-width", "1.5px");
      
      // exit
      lines.exit()
        .remove();
    };
    
    linePlotContainer = ".line-plot-container";
    
    // Initial data
    mu = d3.range(4, 19, 0.5);
    best = Array.apply(null, new Array(32)).map(Number.prototype.valueOf,0);
    samples = [best];
    
    // Draw initial plot
    drawPlot(linePlotContainer, 0, mu, best, samples);
    
    // Execute the query
    function submitQuery() {
      data = {
        l: $('input[name="gal-l"]').val(),
        b: $('input[name="gal-b"]').val()
      };
      
      $("#submit-btn-icon").attr("class", "fa fa-spinner fa-spin fa-lg");
      
      $.ajax({
        type: "POST",
        url: "/gal-lb-query",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify(data),
        success: function(data) {
          //console.log(data);
          mu = $.parseJSON(data.mu);
          best = $.parseJSON(data.best);
          samples = $.parseJSON(data.samples);
          drawPlot(linePlotContainer, 500, mu, best, samples);
          $("#postage-stamp-1").attr("src", data.image1);
          $("#postage-stamp-2").attr("src", data.image2);
          $("#postage-stamp-3").attr("src", data.image3);
          $("#ps-label-1").text(data.label1);
          $("#ps-label-2").text(data.label2);
          $("#ps-label-3").text(data.label3);
          $("#submit-btn-icon").attr("class", "glyphicon glyphicon-ok");
        },
        error: function() {
          $("#submit-btn-icon").attr("class", "glyphicon glyphicon-ok");
        }
      });
    };
    
    // Bind the query to button click and enter key
    $("#submit-btn").click(function() { submitQuery(); });
    $("#gal-l-input").keypress(function(e) {
      var key = e.which;
      if (key == 13) {
        submitQuery();
      }
    });
    $("#gal-b-input").keypress(function(e) {
      var key = e.which;
      if (key == 13) {
        submitQuery();
      }
    });
    
    // Handle window resizing
    var debounce = function(fn, timeout) {
      var timeoutID = -1;
      return function() {
        if (timeoutID > -1) {
          window.clearTimeout(timeoutID);
        }
        timeoutID = window.setTimeout(fn, timeout);
      }
    };
    
    var debouncedDrawPlot = debounce(function() {
      drawPlot(linePlotContainer, 200, mu, best, samples);
    }, 125);
    
    $(window).resize(debouncedDrawPlot);
    
  });
</script>

{% endblock %}
