{% extends "layout.html" %}
{% set active_page = "query" %}

{% block content %}

<div class="container-fluid">
  <div class="row black">
    
    <div class="col-xs-12 col-sm-6 col-md-6 padding-xs-5 green">
      <div class="input-group">
        <span class="input-group-addon"><i>&#x2113</i></span>
        <input id="gal-l-input" name="gal-l" type="text" class="form-control" placeholder="lon. (&deg)">
      </div>
    </div>
    
    <div class="col-xs-12 col-sm-6 col-md-6 padding-xs-5 blue">
      <div class="input-group">
        <span class="input-group-addon"><i>b</i></span>
        <input id="gal-b-input" name="gal-b" type="text" class="form-control" placeholder="lat. (&deg)">
        <span class="input-group-btn">
          <button class="btn btn-success" type="submit" id="submit-btn">
            <span class="glyphicon glyphicon-ok" id="submit-btn-icon"></span>
          </button>
      </span>
      </div>
    </div>
    
    <div class="col-xs-12 col-sm-12 brown">
      <h1>Reddening vs. Distance</h1>
      <div class="box-aspect-2-1">
        <div class="line-plot-container"></div>
      </div>
    </div>
    
    <div class="col-xs-12 col-sm-12 cyan">
      <h1>Postage Stamps</h1>
      
      <div class="row">
        <div class="thumbnail col-xs-12 col-sm-4 ps-container red">
          <!--<div class="ps-container">-->
            <img id="postage-stamp-1" src="" class="img-responsive ps-img" />
          <!--</div>-->
          <h4 id="ps-label-1" class="ps-label"></h4>
        </div>
        <div class="thumbnail col-xs-12 col-sm-4 ps-container red">
          <img id="postage-stamp-2" src="" class="img-responsive ps-img" />
          <h4 id="ps-label-2" class="ps-label"></h4>
        </div>
        <div class="thumbnail col-xs-12 col-sm-4 ps-container red">
          <img id="postage-stamp-3" src="" class="img-responsive ps-img" />
          <h4 id="ps-label-3" class="ps-label"></h4>
        </div>
      </div>
    </div>
    
  </div>
  
  <div class="row">
    <h1>Download Results</h1>
    <div class="col-xs-8 col-xs-offset-2 col-sm-4 col-sm-offset-4 col-lg-4 col-lg-offset-4 bottom-spacer brown">
      <a class="btn btn-default btn-lg fancy-serif center-block disabled" href="#" target="_blank" id="table-btn">
        <span class="fa fa-table fa-lg"></span> &nbsp View ASCII Table
      </a>
    </div>
  </div>
</div>


<script type=text/javascript>
  $(document).ready(function() {
    
    function packData(xVals, yData) {
      return d3.range(yData.length).map( function(idx) {
        return d3.zip(xVals, yData[idx]);
      });
    };
    
    function drawPlot(container, dt, xVals, yBest, ySamples, conv, noData) {
      var fullwidth = $(container).width(),
          fullheight = $(container).height();
      
      scaling = d3.max([0.5, fullwidth/600]);
      scaling = d3.min([2, scaling]);
      
      console.log("scaling: " + scaling);
      
      labelsize = 14 * scaling;
      ticksize = 12 * scaling;
      
      var margins = {left:70*scaling, right:20*scaling,
                     bottom:80*scaling, top:20*scaling};
      
      var width = fullwidth - margins.left - margins.right,
          height = fullheight - margins.bottom - margins.top;
      
      x = d3.scale.linear()
        .domain(d3.extent(xVals))
        .range([0, width]);
      
      y = d3.scale.linear()
        .domain([0, 1.1*d3.max(yBest)])
        .range([height, 0]);
      
      var line = d3.svg.line()
        .x(function(d) { return x(d[0]); })
        .y(function(d) { return y(d[1]); });
      
      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
      
      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(6);
      
      // SVG Canvas
      if (d3.select(container).selectAll("svg")[0].length < 1) {
        svg = d3.select(container).append("svg")
          .attr("width", fullwidth)
          .attr("height", fullheight)
          .attr("viewBox", "0 0 " + fullwidth + " " + fullheight)
          .append("g")
            .attr("id", "main-group")
            .attr("transform", "translate(" + margins.left + "," + margins.top + ")");
        
        lineGroup = svg.append("g")
          .attr("id", "DM-EBV-lines");
        
        svg.append("g")
          .attr("class", "toggle-converged")
          .style("opacity", 0)
          .append("text")
            .attr("id", "convergence-warning")
            .attr("x", 0.975*width)
            .attr("y", height)
            .attr("dy", (-1*ticksize) + "pt")
            .style("text-anchor", "end")
            .style("font-size", ticksize + "pt")
            .style("font-family", "Cutive Mono")
            .style("fill", "red")
            .text("non-converged!");
        
        svg.append("g")
          .attr("class", "toggle-nodata")
          .style("opacity", 0)
          .append("text")
            .attr("id", "nodata-indicator")
            .attr("x", 0.5*width)
            .attr("y", 0.5*height)
            .attr("dy", (-0.5*ticksize) + "pt")
            .style("text-anchor", "middle")
            .style("font-size", (3*ticksize) + "pt")
            .style("font-family", "Cutive Mono")
            .style("fill", "steelblue")
            .style("opacity", 0.5)
            .text("No Data");
      } else {
        d3.select(container).select("svg")
          .attr("width", fullwidth)
          .attr("height", fullheight)
          .attr("viewBox", "0 0 " + fullwidth + " " + fullheight);
        
        d3.select("#main-group")
          .attr("transform", "translate(" + margins.left + "," + margins.top + ")");
        
        d3.select("#convergence-warning")
          .transition().duration(dt)
          .attr("x", 0.975*width)
          .attr("y", height)
          .attr("dy", (-1*ticksize) + "pt")
          .style("font-size", ticksize + "pt");
        
        d3.select("#nodata-indicator")
          .transition().duration(dt)
          .attr("x", 0.5*width)
          .attr("y", 0.5*height)
          .attr("dy", (-0.5*ticksize) + "pt")
          .style("font-size", (3*ticksize) + "pt");
      }
      
      // x-Axis
      if (svg.selectAll(".x.axis")[0].length < 1) {
        svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
        .append("text")
          .attr("id", "xlabel")
          .attr("x", width/2)
          .attr("dy", (3*ticksize) + "pt")
          .text("Distance Modulus (mags)")
          .style("text-anchor", "middle");
      } else {
        svg.selectAll(".x.axis")
          .attr("transform", "translate(0," + height + ")")
          .transition(dt).duration(dt)
          .call(xAxis);
        
        d3.select("#xlabel")
          .attr("x", width/2)
          .attr("dy", (3*ticksize) + "pt");
      }
      
      // y-Axis
      if (svg.selectAll(".y.axis")[0].length < 1) {
        svg.append("g")
          .attr("class", "y axis")
          .call(yAxis)
        .append("text")
          .attr("id", "ylabel")
          .attr("transform", "rotate(-90)")
          .attr("y", 0)
          .attr("x", -height/2)
          .attr("dy", (-3*ticksize) + "pt")
          .style("text-anchor", "middle")
          .text("E(B-V) (mags)");
      } else {
        svg.selectAll(".y.axis")
          .transition().duration(dt)
          .call(yAxis);
        
        d3.select("#ylabel")
          .attr("x", -height/2)
          .attr("dy", (-3*ticksize) + "pt");
      }
      
      // Fonts
      d3.selectAll(".tick > text")
        .style("font-size", ticksize + "pt")
        .style("font-family", "Lora");
      
      d3.selectAll(".axis > text")
        .style("font-size", labelsize + "pt")
        .style("font-family", "Lora");
      
      // Change plot appearance based on (non-)convergence
      if (conv == 0) {
        lineColor = "red";
        
        d3.selectAll(".toggle-converged")
          .transition().duration(dt)
          .style("opacity", 1);
      } else {
        lineColor = "steelblue";
        
        d3.selectAll(".toggle-converged")
          .transition().duration(dt)
          .style("opacity", 0);
      }
      
      // Indicate absence of data
      if (noData == 1) {
        d3.selectAll(".toggle-nodata")
          .transition().duration(dt)
          .style("opacity", 1);
      } else {
        d3.selectAll(".toggle-nodata")
          .transition().duration(dt)
          .style("opacity", 0);
      }
      
      // Best Line
      bestData = [d3.zip(xVals, yBest)];
      
      var lines = lineGroup.selectAll("#best").data(bestData).attr("class", "line");
      
      // transition from previous paths to new paths
      lines.transition().duration(dt)
        .attr("stroke", lineColor)
        .attr("d", line);
      
      // enter any new data
      lines.enter()
        .append("path")
        .attr("id", "best")
        .attr("class", "line")
        .attr("d", line)
        .attr("stroke", lineColor)
        .attr("stroke-width", "2.5px");
      
      // exit
      lines.exit()
        .remove();
      
      // Samples
      sampleData = packData(xVals, ySamples);
      
      var lines = lineGroup.selectAll("#samples").data(sampleData).attr("class", "line");
      
      // transition from previous paths to new paths
      lines.transition().duration(dt)
        .attr("stroke", lineColor)
        .attr("d", line);
      
      // enter any new data
      lines.enter()
        .append("path")
        .attr("id", "samples")
        .attr("class", "line")
        .attr("d", line)
        .attr("opacity", 0.2)
        .attr("stroke", lineColor)
        .attr("stroke-width", "1.5px");
      
      // exit
      lines.exit()
        .remove();
      
      /*
       *  Mouseover
       */
      
      if (svg.selectAll("#focus")[0].length < 1) {
        focus = svg.append("g")
          .attr("id", "focus")
          .attr("display", "none");
        
        svg.append("rect")
          .attr("id", "mouse-overlay")
          .attr("class", "overlay")
          .attr("width", width)
          .attr("height", height)
          .on("mouseover", function() { d3.select("#focus").attr("display", null); })
          .on("mouseout", function() { d3.select("#focus").attr("display", "none"); })
          .on("mousemove", mouseMove);
        
        focus.append("line")
          .attr("id", "x-indicator")
          .attr("x1", 0)
          .attr("x2", 0)
          .attr("y1", 0)
          .attr("y2", height)
          .attr("stroke", "black")
          .attr("stroke-width", "2px")
          .attr("opacity", 0.15);
        
        focus.append("line")
          .attr("id", "y-indicator")
          .attr("x1", 0)
          .attr("x2", width)
          .attr("y1", 0)
          .attr("y2", 0)
          .attr("stroke", "black")
          .attr("stroke-width", "2px")
          .attr("opacity", 0.15);
        
        txtEl = focus.append("text")
          .attr("id", "text-indicator")
          .attr("x", 0)
          .attr("y", 0)
          .style("text-anchor", "start")
          .style("font-size", ticksize + "pt")
          .style("font-family", "Cutive Mono")
          .style("fill", "steelblue")
          .style("opacity", 0.75)
          .text("");
        
        txtEl.append("tspan")
          .attr("id", "dist-label")
          .attr("x", 0.8*ticksize + "pt")
          .text("");
        
        txtEl.append("tspan")
          .attr("id", "EBV-label")
          .attr("x", 0.8*ticksize + "pt")
          .attr("dy", ticksize + "pt")
          .text("");
      } else {
        d3.select("#mouse-overlay")
          .attr("width", width)
          .attr("height", height);
        
        d3.select("#dist-label")
          .attr("x", 0.8*ticksize + "pt");
        
        d3.select("#EBV-label")
          .attr("x", 0.8*ticksize + "pt")
          .attr("dy", ticksize + "pt");
      }
      
      d3.select("#text-indicator")
        .transition().duration(dt)
        .attr("x", 0.025*width)
        .attr("y", 0.015*height)
        .style("font-size", ticksize + "pt")
        .attr("dy", 0.5*ticksize + "pt");
      
      var bisect_x = d3.bisector(function(d) { return d; }).left;
      var text_formatter = d3.format(".2f");
      
      function mouseMove() {
        var xDisp = d3.mouse(this)[0];
        var xCoord = x.invert(xDisp);
        var i = bisect_x(mu, xCoord, 1);
        y0 = best[i-1];
        y1 = best[i];
        x0 = mu[i-1];
        x1 = mu[i];
        var yCoord = y0 + (y1-y0)/(x1-x0) * (xCoord-x0);
        var yDisp = y(yCoord);
        
        DM = Math.pow(10, xCoord/5 - 2);
        
        /*
        console.log(best);
        console.log(best.length);
        console.log(i);
        console.log("x0:" + x0);
        console.log("x1:" + x1);
        console.log("y0:" + y0);
        console.log("y1:" + y1);
        console.log("(" + xDisp + ", " + yDisp + ") -> (" + xCoord + ", " + yCoord + ")");
        */
        
        d3.select("#x-indicator")
          .attr("y1", y(0))
          .attr("y2", yDisp)
          .attr("x1", xDisp)
          .attr("x2", xDisp);
        
        d3.select("#y-indicator")
          .attr("y1", yDisp)
          .attr("y2", yDisp)
          .attr("x1", x(xVals[0]))
          .attr("x2", xDisp);
        
        d3.select("#dist-label")
          .text("d = " + text_formatter(DM) + " kpc");
        
        d3.select("#EBV-label")
          .text("E(B-V) = " + text_formatter(yCoord));
        
        //console.log(d3.select("#text-indicator"));
        //console.log(text_formatter(xCoord));
        //console.log(xCoord);
      }
    };
    
    linePlotContainer = ".line-plot-container";
    
    // Initial data
    mu = d3.range(4, 19.01, 0.5);
    best = Array.apply(null, new Array(mu.length)).map(Number.prototype.valueOf,0);
    samples = [best];
    converged = 1;
    tableData = "";
    noData = 0;
    
    // Current view
    lCur = 0;
    bCur = 0;
    rCur = 0;
    
    // Draw initial plot
    drawPlot(linePlotContainer, 0, mu, best, samples, converged, noData);
    
    // Execute the query
    function submitQuery() {
      data = {
        l: $('input[name="gal-l"]').val(),
        b: $('input[name="gal-b"]').val()
      };
      
      $("#submit-btn-icon").attr("class", "fa fa-spinner fa-spin fa-lg");
      
      $.ajax({
        type: "POST",
        url: "/gal-lb-query",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify(data),
        success: function(data) {
          querySuccess = $.parseJSON(data.success);
          mu = $.parseJSON(data.mu);
          best = $.parseJSON(data.best);
          samples = $.parseJSON(data.samples);
          converged = $.parseJSON(data.converged);
          tableData = $.parseJSON(data.table_data);
          
          lCur = $.parseJSON(data.l);
          bCur = $.parseJSON(data.b);
          rCur = $.parseJSON(data.radius);
          
          noData = 1 - querySuccess;
          
          drawPlot(linePlotContainer, 500, mu, best, samples, converged, noData);
          
          $("#postage-stamp-1").attr("src", data.image1);
          $("#postage-stamp-2").attr("src", data.image2);
          $("#postage-stamp-3").attr("src", data.image3);
          $("#ps-label-1").text(data.label1);
          $("#ps-label-2").text(data.label2);
          $("#ps-label-3").text(data.label3);
          $("#submit-btn-icon").attr("class", "glyphicon glyphicon-ok");
          
          if (querySuccess == 1) {
            toggleTableBtn(false);
            $("#table-btn").attr("href", tableData);
          } else {
            toggleTableBtn(true);
            console.log("toggling button off");
          }
          
          drawPSOverlays();
        },
        error: function() {
          $("#submit-btn-icon").attr("class", "glyphicon glyphicon-ok");
          
          toggleTableBtn(true);
        }
      });
    };
    
    // Bind the query to button click and enter key
    $("#submit-btn").click(function() { submitQuery(); });
    $("#gal-l-input").keypress(function(e) {
      var key = e.which;
      if (key == 13) {
        submitQuery();
      }
    });
    $("#gal-b-input").keypress(function(e) {
      var key = e.which;
      if (key == 13) {
        submitQuery();
      }
    });
    
    // Toggle ASCII table link
    function toggleTableBtn(disable) {
      d3.select("#table-btn").classed("disabled", disable);
    }
    
    
    /*
     * Postage Stamp Overlays
     */
    
    drawPSOverlays();
    
    function drawPSOverlays() {
      var psContainers = d3.selectAll(".ps-container");
      
      // Create SVG overlays, if they do not yet exist
      var psSVG = d3.selectAll(".ps-overlay");
      
      if (psSVG[0].length < 1) {
        psSVG = psContainers.append("svg")
          .attr("class", "ps-overlay")
          .style("position", "absolute")
          .style("top", "0px")
          .style("left", "0px");
        
        var psBullseye = psSVG.append("g")
          .attr("class", "ps-bullseye")
          .style("opacity", 0.75);
        
        psBullseye.append("circle")
          .attr("class", "ps-bullseye-outer")
          .attr("fill", "none")
          .attr("stroke", "#FFD35C")
          .attr("stroke-width", "3px")
          .attr("x", 0)
          .attr("y", 0);
        
        psBullseye.append("circle")
          .attr("class", "ps-bullseye-inner")
          .attr("fill", "#FFD35C")
          .attr("x", 0)
          .attr("y", 0);
        
        focus = psSVG.append("g")
          .attr("class", "ps-focus")
          .attr("display", "none");
        
        //var psTxtBG = focus.append("rect")
        //  .attr("class", "ps-text-bg");
        
        var psTxtEl = focus.append("text")
          .attr("class", "ps-text-indicator")
          .style("text-anchor", "start");
        
        psTxtEl.append("tspan")
          .text("l = 0")
          .attr("class", "ps-l-label");
        
        psTxtEl.append("tspan")
          .attr("class", "ps-b-label")
          .text("b = 0");
        
        psOverlayRect = psSVG.append("rect")
          .attr("class", "overlay");
        
        psOverlayRect.each(function(d,i) {
          var assocFocus = d3.selectAll(".ps-focus")[0][i];
          d3.select(this)
            .on("mouseover", function() {
              d3.select(assocFocus).attr("display", null);
            })
            .on("mouseout", function() {
              d3.select(assocFocus).attr("display", "none");
            });
        });
      }
      
      psContainers.each(function(d,i) {
        var imgProp = getPosExtent(d3.select(this).select(".ps-img")[0]);
        
        d3.select(this).select(".ps-overlay")
          .attr("width", imgProp.width + "px")
          .attr("height", imgProp.height + "px")
          .style("left", imgProp.left + "px")
          .style("top", imgProp.top + "px");
        
        // Update bullseye
        var rOuter = imgProp.width / 40;
        rOuter = d3.max([rOuter, 8]);
        rOuter = d3.min([rOuter, 24]);
        
        var rInner = rOuter / 4.
        
        d3.select(this).select(".ps-bullseye-outer")
          .attr("r", rOuter);
        d3.select(this).select(".ps-bullseye-inner")
          .attr("r", rInner);
        d3.select(this).select(".ps-bullseye")
          .attr("transform", "translate(" + imgProp.width/2. + "," + imgProp.height/2. + ")");
        
        // Update coordinate labels
        var psScaling = imgProp.width / 200;
        psScaling = d3.max([psScaling, 0.5]);
        psScaling = d3.min([psScaling, 3.]);
        
        var psFontSize = 14 * psScaling;
        
        var psTxt = d3.select(this).select(".ps-text-indicator")
          .attr("x", 1.2*psFontSize + "pt")
          .attr("y", 1.2*psFontSize + "pt")
          .style("font-size", psFontSize + "pt");
        
        psTxt.select(".ps-l-label")
          .attr("x", 0.5*psFontSize + "pt");
        
        psTxt.select(".ps-b-label")
          .attr("x", 0.5*psFontSize + "pt")
          .attr("dy", psFontSize + "pt");
        
        // Update mouse overlay
        var self = this;
        
        // Properties of Postage-stamp Gnomonic projection
        var lng0 = deg2rad(lCur);
        var cLat0 = Math.cos(deg2rad(bCur));
        var sLat0 = Math.sin(deg2rad(bCur));
        var xMaxProj = GnomonicProj(deg2rad(rCur), 0, 0, 1, 0).x;
        
        var lb_formatter = d3.format(".1f");
        
        //console.log(rCur);
        //console.log(xMaxProj);
        
        d3.select(this).select(".overlay")
          .attr("width", imgProp.width)
          .attr("height", imgProp.height)
          .on("mousemove", function() {
            var xDisp = d3.mouse(this)[0];
            var yDisp = d3.mouse(this)[1];
            
            var xProj = -2 * (xDisp / imgProp.width - 0.5) * xMaxProj;
            var yProj = -2 * (yDisp / imgProp.height - 0.5) * xMaxProj;
            
            var coords = GnomonicProjInv(xProj, yProj, lng0, cLat0, sLat0);
            
            d3.select(self).select(".ps-l-label")
              .text("\u2113 = " + lb_formatter(rad2deg(coords.lng)) + "\u00B0");
            d3.select(self).select(".ps-b-label")
              .text("b = " + lb_formatter(rad2deg(coords.lat)) + "\u00B0");
          });
      });
    }
    
    function getPosExtent(obj) {
      var xy0 = $(obj).position();
      var x0 = xy0.left;
      var y0 = xy0.top;
      
      x0 += parseInt($(obj).css("padding-left"), 10);
      y0 += parseInt($(obj).css("padding-top"), 10);
      
      x0 += parseInt($(obj).css("margin-left"), 10);
      y0 += parseInt($(obj).css("margin-top"), 10);
      
      var w = parseInt($(obj).css("width"), 10);
      var h = parseInt($(obj).css("height"), 10);
      
      return {"left": x0, "top": y0, "width": w, "height": h};
    }
    
    function dispCoord() {
      var xDisp = d3.mouse(this)[0];
      var yDisp = d3.mouse(this)[1];
      console.log("(x,y) = (" + xDisp + ", " + yDisp + ")");
    }
    
    
    // Gnomonic projection
    function GnomonicProj(lng, lat, lng0, cLat0, sLat0) {
      var cLat = Math.cos(lat);
      var sLat = Math.sin(lat);
      
      var cDLng = Math.cos(lng - lng0);
      var sDLng = Math.sin(lng - lng0);
      
      var aProj = 1. / (sLat0 * sLat + cLat0 * cLat * cDLng);
      
      var xProj = aProj * cLat * sDLng;
      var yProj = aProj * (cLat0 * sLat - sLat0 * cLat * cDLng);
      
      return {"x": xProj, "y": yProj};
    }
    
    function GnomonicProjInv(xProj, yProj, lng0, cLat0, sLat0) {
      var rho = Math.sqrt(xProj*xProj + yProj*yProj);
      var c = Math.atan(rho);
      
      var cc = Math.cos(c);
      var sc = Math.sin(c);
      
      var lat = Math.asin(cc * sLat0 + yProj * sc * cLat0 / rho);
      var lng = lng0 + Math.atan2((xProj * sc), (rho * cLat0 * cc - yProj * sLat0 * sc));
      
      if (lng > 360) {
        lng -= 360;
      }
      
      return {"lng": lng, "lat": lat};
    }
    
    function deg2rad(theta) {
      return Math.PI / 180 * theta;
    }
    
    function rad2deg(theta) {
      return 180 / Math.PI * theta;
    }
    
    
    // Handle window resizing
    var debounce = function(fn, timeout) {
      var timeoutID = -1;
      return function() {
        if (timeoutID > -1) {
          window.clearTimeout(timeoutID);
        }
        timeoutID = window.setTimeout(fn, timeout);
      }
    };
    
    var debouncedDrawPlot = debounce(function() {
      drawPlot(linePlotContainer, 200, mu, best, samples, converged, noData);
      //drawPSOverlays();
    }, 125);
    
    var debouncedDrawPSOverlays = debounce(function() {
      //drawPlot(linePlotContainer, 200, mu, best, samples, converged, noData);
      drawPSOverlays();
    }, 250);
    
    $(window).resize(debouncedDrawPlot);
    $(window).resize(debouncedDrawPSOverlays);
    
    
  });
</script>

{% endblock %}
